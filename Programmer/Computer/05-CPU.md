<!-- TOC -->

- [中央处理器](#中央处理器)
    - [寄存器](#寄存器)
    - [运算器](#运算器)
        - [数据缓冲器](#数据缓冲器)
        - [ALU](#alu)
        - [状态字寄存器](#状态字寄存器)
        - [通用寄存器](#通用寄存器)
    - [控制器](#控制器)
        - [程序计数器](#程序计数器)
        - [时序发生器](#时序发生器)
        - [指令译码器](#指令译码器)
        - [指令寄存器](#指令寄存器)
        - [主存数据寄存器](#主存数据寄存器)
        - [通用寄存器](#通用寄存器-1)
- [指令系统](#指令系统)
    - [组成](#组成)
    - [操作类型](#操作类型)
    - [寻址方式](#寻址方式)
- [执行过程](#执行过程)
    - [指令执行过程](#指令执行过程)
    - [CPU 的流水线设计](#cpu-的流水线设计)

<!-- /TOC -->

# 中央处理器

```sh
       CPU
 ------------------        ----------
   ------------- 地址总线
   数据地址生成器 -------->
   -------------
        ↑
        ↓
   -------------
     程序序列器 
     ---------    数据总线
      指令缓存 ----------->
     ---------
   -------------             存储器
        ↑                    Memory
        ↓
   -------------  数据总线
   通用目的寄存器 <-------->
   -------------
        ↑
        ↓
   -------------
      计算单元
      -------
    算术逻辑单元
      -------
       乘法器               ----------
      -------
       移位器
      -------
   -------------
 ------------------
```

硬件系统的核心是中央处理器（Central Processing Unit，简称 CPU）。它主要由控制器、运算器等组成，并采用大规模集成电路工艺制成的芯片，又称微处理器芯片。程序是由指令构成的, 处理器是执行指令的硬件设备, 一个系统中可能有多个处理器.

## 寄存器

> 寄存器是在 CPU 核心中的、用于暂存数据的存储单元。一般处理器内部对数据的算术逻辑计算往往都需要通过寄存器（Register），而不是直接对外部存储器进行操作。因此，如果我们要计算一个加法或乘法计算，需要先把相关数据从外部存储器读到处理器自己的通用目的寄存器中，然后对寄存器做计算操作，再将计算结果也放入寄存器，最后将结果寄存器中的数据再写入外部存储器。寄存器的访问速度非常快，它是这三种存储介质中速度最快的，但是数量也是最少的。像在传统的 32 位 x86 处理器体系结构下，程序员一般能直接用的通用目的寄存器只有 EAX、EBX、ECX、EDX、ESI、EDI、EBP 这 7 个。还有一个 ESP 用于操作堆栈，往往无法用来处理通用计算。

## 运算器

![](../../.resource/Programmer/Computer/CPU/运算器.png)

运算器又称算术逻辑单元（Arithmetic Logic Unit 简称 ALU）。它是计算机对数据进行加工处理的部件，包括算术运算（加、减、乘、除等）和逻辑运算（与、或、非、异或、比较等）。

### 数据缓冲器

- 分为输入缓冲和输出缓冲
- 输入缓冲暂时存放外设送过来的数据
- 输出缓冲暂时存放送往外设的数据

### ALU

- ALU: 算术逻辑单元, 是运算器的主要组成
- 常见的位运算(左右移、与或非等)
- 算术运算(加减乘除等)

### 状态字寄存器

- 存放运算状态(条件码、进位、溢出、结果正负等)
- 存放运算控制信息(调试跟踪标记位、允许中断位等)

### 通用寄存器

- 用于暂时存放或传送数据或指令
- 可保存 ALU 的运算中间结果
- 容量比一般专用寄存器更大

## 控制器

![](../../.resource/Programmer/Computer/CPU/控制器.png)

控制器负责从存储器中取出指令，并对指令进行译码；根据指令的要求，按时间的先后顺序，负责向其它各部件发出控制信号，保证各部件协调一致地工作，一步一步地完成各种操作。控制器主要由指令寄存器、译码器、程序计数器、操作控制器等组成。

### 程序计数器

- 程序计数器用来存储下一条指令的地址
- 循环从程序计数器中拿出指令
- 当指令被拿出时, 指向下一条指令

### 时序发生器

- 电气工程领域, 用于发送时序脉冲
- CPU 依据不同的时序脉冲有节奏的进行工作

### 指令译码器

- 指令译码器是控制器的主要部件之一
- 计算机指令由操作码和地址码组成
- 翻译操作码对应的操作以及控制传输地址码对应的数据

### 指令寄存器

- 指令寄存器也是控制器的主要部件之一
- 从主存或高速缓存存取计算机指令

### 主存数据寄存器

- 保存当前 CPU 正要读或写的主存数据

### 通用寄存器

- 用于暂时存放或传送数据或指令
- 可保存 ALU 的运算中间结果
- 容量比一般专用寄存器要大

# 指令系统

## 组成

1. 机器指令主要由两部分组成: 操作码 + 地址码
2. 操作码指明指令所要完成的操作
    - 操作码的位数反映了机器的操作种类
    - 如: 操作码字段有 8 位, 则表明它最多有 256 种操作
3. 地址码直接给出操作数或操作数的地址
    - 分三地址指令、二地址指令和一地址指令
    - 三地址指令: 操作码(OP) addr1 addr2 addr3, 如: k = i + j
    - 二地址指令: 操作码(OP) addr1 addr2, 如: i || j
    - 一地址指令: 操作码(OP) addr1, 如: ++i
    - 零地址指令: 在机器指令中无地址码, 如: 空操作、停机操作、中断返回操作等

## 操作类型

1. 数据传输
    - 寄存器之间、寄存器与存储单元、存储单元之间传送
    - 数据读写、交换地址数据、清零置一等操作
2. 算术逻辑操作
    - 操作数之间的加减乘除运算
    - 操作数的与或非等逻辑位运算
3. 移位操作
    - 数据左移(乘 2)、数据右移(除 2)
    - 完成数据在算术逻辑单元的必要操作
4. 控制指令
    - 等待指令、停机指令、空操作、中断指令等

## 寻址方式

1. 指令寻址
    - 顺序寻址
    - 跳跃寻址

地址|指令|说明
:---|:---:|:---
101|MOV R0,R1|顺序
102|LAD R1,6|顺序
103|ADD R1,R2|顺序
104|ADD R1,R3|顺序
105|JMP 102|跳跃

2. 数据寻址
    - 立即寻址
        - 操作码(OP) addr1 6
        - 指令直接获得操作数 6
        - 无需访问存储器
    - 直接寻址
        - 操作码(OP) addr1 6
        - 直接给出操作数在主存的地址 addr1
        - 寻找操作数简单, 无需计算数据地址
    - 间接寻址
        - 操作码(OP) R1 addr2
        - 指令地址码给出的是操作数地址的地址
        - 需要反问一次或多次主存来获取操作数

# 执行过程

> 处理器在执行一段程序时，通常先从外部存储器取得指令，然后对指令进行译码处理，转换为相关的一系列操作。这些操作可能是对寄存器的算术逻辑运算，也可能是对存储器的读写操作，然后执行相关计算。最后把计算结果写回寄存器或写回到存储器。不过处理器在执行一系列指令的时候并不是每条指令都必须先经过上面所描述的整个过程才能执行下一条，而是采用流水线的方式执行。

## 指令执行过程

```sh
   IF      ID     EX     MEM     WB
  取指 -> 译码 -> 执行 -> 访存 -> 写回
   ↑                              ↓
  输入                           输出

 t1  t2  t3  t4  t5  t6  t7  t8
 IF  ID  EX  MEM WB
     IF  ID  EX  MEM WB
         IF  ID  EX  MEM WB
             IF  ID  EX  MEM WB
```

> 上面流程体现了一个简单的处理器执行完一条指令的完整过程。我们这里假设从第一个取指令阶段到最后的写回阶段，这 4 个阶段均花费 1 个周期，倘若不是采用流水线的方式，而是每完成一条指令的执行再执行下一条指令，那么每条指令的处理都需要 4 个周期。而一旦采用流水线方式处理，那么我们可以看到，在第一条指令执行到译码阶段时，处理器可以对第二条指令做取指令操作；当第一条指令执行到执行阶段时，第二条指令执行到了译码阶段，此时第三条指令开始做取指令阶段，然后以此类推。这样，当整条流水线填充满之后，即执行到了第 5 条指令，那么对于后续指令而言，处理每一条指令的时间均只需要一个周期。<br>
> 这里需要注意的是，并不是每条指令都需要访存操作，只有当需要对外部存储器做读写操作时才会动用访存执行单元。然而大部分指令都需要写回寄存器操作，即便像一条用于比较大小的指令，或一条系统中断指令，它们也会影响状态寄存器。当然，很多处理器会有空操作（NOP）指令，它仅仅占用一个时钟周期，而不会对除了指令指针寄存器以外的任何寄存器产生影响。

## CPU 的流水线设计

- 类似工厂的装配线
- 工厂的装配线使得多个产品可以同时被加工
- 在同一个时刻, 不同产品均位于不同的加工阶段
